<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script src="/js/select2.min.js"></script>
<script src="/js/searchbar.js"></script>
<script src="/js/reviewondishpage.js"></script>
<script src="/js/additemonrestaurant.js"></script>
<script src="/js/writereview.js"></script>
<script type="text/javascript">
	$(document).ready(function(){
		$("#logout").click(function(event) {
			event.preventDefault()
	  	firebase.auth().signOut().then(function(){
	  		window.location.href = "/logout"
	    },function(error) {
	      console.log("ERROR: "+error.message)
	      alert("Something went wrong logging you out. Please refresh and try again.")
	    })
		})
		
		//Saving and Unsaving Dishes and Restaurants.
		$('input[type="checkbox"][name="fav_dishkey"]').click(function(){
      var favdishkey=$(this).val();
      var user= firebase.auth().currentUser.uid;
      if($(this).prop("checked") == true){
        var data={
          favdishkey: favdishkey,
          user: user,
          add: true
        }
        $.post('/newFavDish', data);
      }
      else if($(this).prop("checked") == false){
        var data={
          favdishkey: favdishkey,
          user: user,
          add: false
        }
        $.post('/newFavDish', data);
      }
    });
    
    $('input[type="checkbox"][name="fav_reskey"]').click(function(){
      var favreskey=$(this).val();
      var user= firebase.auth().currentUser.uid;
      if($(this).prop("checked") == true){
        var data={
          favreskey: favreskey,
          user: user,
          add: true
        }
        $.post('/newFavRes', data);
      }
      else if($(this).prop("checked") == false){
        var data={
          favreskey: favreskey,
          user: user,
          add: false
        }
        $.post('/newFavRes', data);
      }
    });	
    
    
    // Submit new item to restaurant
		var storageRef = firebase.storage().ref()
		var imagePathRef = firebase.database().ref("ImagePaths/Dishes")
		var dishRef
		var newDishKey
		var newDishImage
		var smallDishImageRef 
    var fullDishImageRef 
    var fileName = "/dish.jpg"
    
    $("[action='/newItem']").on('submit', function(event) {
    		event.preventDefault()
    		newDishImage = document.querySelector("[name='adddishimage']").files[0]
    		
    		$.post('/newItem', $("[action='/newItem']").serialize(), function(response) {
    			console.log(response)
    			newDishKey = response.newDishRef
    			
    			if(newDishImage != null) {
    				dishRef = firebase.database().ref("Dishes/"+ newDishKey)
    				smallDishImageRef = storageRef.child("thumbnailSized/Dishes/" + newDishKey + fileName)
    				fullDishImageRef = storageRef.child("fullSizedImage/Dishes/" + newDishKey + fileName)
    				
    				smallDishImageRef.put(newDishImage).then(function() {
    					console.log("small image set")
    					return fullDishImageRef.put(newDishImage)
    				}).then(function() {
    					console.log("full image set")
    					return linkDishImages(dishRef, newDishKey, smallDishImageRef, fullDishImageRef)
    				})
    				
    			}
    			
    		})
    		

    	
    	
    })
    
    function linkDishImages(dishRef, newDishKey, smallDishImageRef, fullDishImageRef) {
    	smallDishImageRef.getDownloadURL().then(function(imgURL) {
    		dishRef.child("thumbnail_URL").set(imgURL)
    		imagePathRef.child(newDishKey+"/thumbnailSized").set(imgURL)
    		console.log("set dish and small img ref")
    	})
    	
    	fullDishImageRef.getDownloadURL().then(function(imgURL) {
    		imagePathRef.child(newDishKey+"/fullSizedImage").set(imgURL)
    		console.log("set large img ref")
    	})
    	
    }
    
    
	})
	
</script>